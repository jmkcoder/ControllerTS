{% extends "shared/_base.njk" %}

{% block content %}
<div class="container">
  <h1>{{ title }}</h1>
  
  <!-- Filter Form -->
  <div class="filter-section">
    <h3>Filter Products</h3>
    <form method="get" action="/products" class="filter-form">
      <div class="filter-row">
        <div class="filter-group">
          <label for="category">Category:</label>
          <select id="category" name="category">
            {% for cat in categories %}
              <option value="{{ cat }}" {% if filters.category == cat %}selected{% endif %}>
                {{ cat | title }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label for="price_min">Min Price:</label>
          <input type="number" id="price_min" name="price_min" value="{{ filters.priceMin }}" min="0" step="0.01">
        </div>
        
        <div class="filter-group">
          <label for="price_max">Max Price:</label>
          <input type="number" id="price_max" name="price_max" value="{{ filters.priceMax }}" min="0" step="0.01">
        </div>
        
        <div class="filter-group">
          <label for="sortBy">Sort By:</label>
          <select id="sortBy" name="sortBy">
            <option value="name" {% if filters.sortBy == 'name' %}selected{% endif %}>Name</option>
            <option value="price_asc" {% if filters.sortBy == 'price_asc' %}selected{% endif %}>Price (Low to High)</option>
            <option value="price_desc" {% if filters.sortBy == 'price_desc' %}selected{% endif %}>Price (High to Low)</option>
          </select>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label>
            <input type="checkbox" name="inStock" value="true" {% if filters.inStock %}checked{% endif %}>
            In Stock Only
          </label>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label>Tags (select multiple):</label>
          <div class="tag-selection">
            {% for tag in availableTags %}
              <label class="tag-label">
                <input type="checkbox" name="tag" value="{{ tag }}" 
                       {% if tag in filters.tags %}checked{% endif %}>
                {{ tag }}
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <div class="filter-actions">
        <button type="submit">Apply Filters</button>
        <a href="/products/clear-filters" class="clear-button">Clear All</a>
      </div>
    </form>
  </div>

  <!-- Quick Filters -->
  <div class="quick-filters">
    <h4>Quick Filters:</h4>
    <a href="/products/quick-filter?type=programming-books" class="quick-filter-btn">Programming Books</a>
    <a href="/products/quick-filter?type=electronics-under-500" class="quick-filter-btn">Electronics Under $500</a>
    <a href="/products/quick-filter?type=in-stock-only" class="quick-filter-btn">In Stock Only</a>
  </div>

  <!-- Results Summary -->
  <div class="results-summary">
    <p><strong>Showing {{ products.length }} of {{ totalProducts }} products</strong></p>
    {% if pagination.totalPages > 1 %}
      <p>Page {{ pagination.currentPage }} of {{ pagination.totalPages }}</p>
    {% endif %}
  </div>

  <!-- Products Grid -->
  <div class="products-grid">
    {% for product in products %}
      <div class="product-card">
        <h3>{{ product.name }}</h3>
        <p class="price">${{ product.price }}</p>
        <p class="category">{{ product.category | title }}</p>
        <div class="tags">
          {% for tag in product.tags %}
            <span class="tag">{{ tag }}</span>
          {% endfor %}
        </div>
        <p class="stock-status {{ 'in-stock' if product.inStock else 'out-of-stock' }}">
          {{ 'In Stock' if product.inStock else 'Out of Stock' }}
        </p>
      </div>
    {% endfor %}
  </div>

  {% if products.length == 0 %}
    <div class="no-results">
      <h3>No products found</h3>
      <p>Try adjusting your filters or <a href="/products/clear-filters">clear all filters</a>.</p>
    </div>
  {% endif %}

  <!-- Pagination -->
  {% if pagination.totalPages > 1 %}
    <div class="pagination">
      {% if pagination.hasPrevious %}
        <a href="{{ pagination.firstUrl }}" class="page-link">&laquo;&laquo; First</a>
        <a href="{{ pagination.previousUrl }}" class="page-link">&laquo; Previous</a>
      {% endif %}

      <span class="page-info">
        Page {{ pagination.currentPage }} of {{ pagination.totalPages }}
      </span>

      {% if pagination.hasNext %}
        <a href="{{ pagination.nextUrl }}" class="page-link">Next &raquo;</a>
        <a href="{{ pagination.lastUrl }}" class="page-link">Last &raquo;&raquo;</a>
      {% endif %}
    </div>
  {% endif %}

  <!-- Debug Information -->
  <details class="debug-section">
    <summary>Debug: Current Query Parameters</summary>
    <div class="debug-content">
      <h4>Query Parameters:</h4>
      <pre>{{ queryParams | dump(2) }}</pre>
      
      <h4>Active Filters:</h4>
      <pre>{{ filters | dump(2) }}</pre>
    </div>
  </details>

  <!-- Navigation -->
  <div class="navigation">
    <a href="/">Back to Home</a>
    <a href="/home/search">Search Demo</a>
  </div>
</div>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .filter-section {
    background: #f8f9fa;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
  }
  
  .filter-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .filter-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: end;
  }
  
  .filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
  }
  
  .filter-group label {
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .filter-group input,
  .filter-group select {
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
  }
  
  .tag-selection {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    max-width: 600px;
  }
  
  .tag-label {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    background: #e9ecef;
    border-radius: 15px;
    font-size: 0.9em;
    cursor: pointer;
  }
  
  .tag-label:hover {
    background: #dee2e6;
  }
  
  .tag-label input[type="checkbox"] {
    margin: 0;
  }
  
  .filter-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .filter-actions button {
    padding: 10px 20px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .filter-actions button:hover {
    background: #0056b3;
  }
  
  .clear-button {
    padding: 10px 20px;
    background: #6c757d;
    color: white;
    text-decoration: none;
    border-radius: 4px;
  }
  
  .clear-button:hover {
    background: #545b62;
  }
  
  .quick-filters {
    margin-bottom: 20px;
    padding: 15px;
    background: #e7f3ff;
    border-radius: 4px;
  }
  
  .quick-filter-btn {
    display: inline-block;
    margin: 5px 10px 5px 0;
    padding: 8px 12px;
    background: #17a2b8;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.9em;
  }
  
  .quick-filter-btn:hover {
    background: #138496;
  }
  
  .results-summary {
    padding: 15px;
    background: #fff3cd;
    border: 1px solid #ffeeba;
    border-radius: 4px;
    margin-bottom: 20px;
  }
  
  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .product-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .product-card h3 {
    margin: 0 0 10px 0;
    color: #333;
  }
  
  .price {
    font-size: 1.5em;
    font-weight: bold;
    color: #28a745;
    margin: 10px 0;
  }
  
  .category {
    color: #6c757d;
    font-style: italic;
    margin: 5px 0;
  }
  
  .tags {
    margin: 10px 0;
  }
  
  .tag {
    display: inline-block;
    background: #007bff;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin: 2px;
  }
  
  .stock-status {
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 4px;
    text-align: center;
  }
  
  .in-stock {
    background: #d4edda;
    color: #155724;
  }
  
  .out-of-stock {
    background: #f8d7da;
    color: #721c24;
  }
  
  .no-results {
    text-align: center;
    padding: 40px;
    background: #f8f9fa;
    border-radius: 8px;
    margin: 20px 0;
  }
  
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin: 30px 0;
    flex-wrap: wrap;
  }
  
  .page-link {
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-decoration: none;
    color: #007bff;
    background: white;
  }
  
  .page-link:hover {
    background: #e9ecef;
  }
  
  .page-info {
    padding: 8px 15px;
    background: #e9ecef;
    border-radius: 4px;
    font-weight: bold;
  }
  
  .debug-section {
    margin-top: 40px;
    padding: 20px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }
  
  .debug-content {
    margin-top: 15px;
  }
  
  .debug-content pre {
    background: #e9ecef;
    padding: 15px;
    border-radius: 4px;
    overflow-x: auto;
  }
  
  .navigation {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
  }
  
  .navigation a {
    margin-right: 15px;
    color: #007bff;
    text-decoration: none;
  }
  
  .navigation a:hover {
    text-decoration: underline;
  }
  
  @media (max-width: 768px) {
    .filter-row {
      flex-direction: column;
      align-items: stretch;
    }
    
    .products-grid {
      grid-template-columns: 1fr;
    }
    
    .tag-selection {
      max-width: none;
    }
    
    .pagination {
      flex-direction: column;
    }
  }
</style>
{% endblock %}
